name: Data Pipeline Auto-Runner

# 트리거 조건 수정됨
on:
  schedule:
    - cron: '*/5 * * * *'  # 여기가 핵심: 5분마다 자동 실행
  push:                    # 코드를 수정해서 올릴 때도 실행
  workflow_dispatch:       # 수동으로 버튼 눌러서 실행 가능

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    
    # 레포지토리에 파일을 다시 쓰기 위한 권한 설정
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Data Pipeline Script
        run: |
          # --- 변수 설정 (본인 이름으로 수정 필수) ---
          USER_NAME="Choi"
          FILE_NAME="${USER_NAME}_test.json"
          # ----------------------------------------

          # 1. 시간 계산 (현재 분 + 1)
          CURRENT_MIN=$(date +%M)
          # 08, 09 등을 10진수로 인식시키기 위해 10# 사용
          TARGET_ID=$((10#$CURRENT_MIN + 1))
          
          echo "현재 시각(분): $CURRENT_MIN, 수집 타겟 ID: $TARGET_ID"

          # 2. API 호출 URL 생성
          URL="https://jsonplaceholder.typicode.com/todos/${TARGET_ID}"

          # 3. 데이터 수집
          NEW_DATA=$(curl -s "$URL")

          # 4. /tmp/ 디렉토리에 임시 저장 (문제 조건 충족)
          echo "$NEW_DATA" >> "/tmp/$FILE_NAME"

          # 5. Incremental Update (JSON 배열 형식 유지하며 누적)
          if [ ! -f "$FILE_NAME" ]; then
            # 파일이 없으면 새로 생성 (배열 시작)
            echo "[" > "$FILE_NAME"
            echo "$NEW_DATA" >> "$FILE_NAME"
            echo "]" >> "$FILE_NAME"
          else
            # 파일이 있으면 마지막 대괄호 ]를 지우고 콤마(,) 추가 후 데이터 덧붙임
            # sed -i '$d' : 마지막 줄 삭제
            sed -i '$d' "$FILE_NAME"
            echo "," >> "$FILE_NAME"
            echo "$NEW_DATA" >> "$FILE_NAME"
            echo "]" >> "$FILE_NAME"
          fi
          
          # 로그 확인용
          cat "$FILE_NAME"

      - name: Commit and Push changes
        run: |
          USER_NAME="HongGildong" # 위와 동일하게 수정하세요
          FILE_NAME="${USER_NAME}_test.json"
          
          git config --global user.name "github-actions-bot"
          git config --global user.email "github-actions-bot@users.noreply.github.com"
          
          # 변경 사항이 있을 때만 커밋 (빈 커밋 에러 방지)
          git add "$FILE_NAME"
          git commit -m "Auto-update: Data collected at $(date)" || echo "No changes to commit"
          git push


