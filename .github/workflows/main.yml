name: Data Pipeline Auto-Runner

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
  workflow_dispatch:

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Data Pipeline Script
        run: |
          # --- 변수 설정 ---
          USER_NAME="Choi"   # 여기는 Choi로 잘 하셨습니다.
          FILE_NAME="${USER_NAME}_test.json"
          # ----------------

          # 1. 시간 계산
          CURRENT_MIN=$(date +%M)
          TARGET_ID=$((10#$CURRENT_MIN + 1))
          
          echo "현재 시각(분): $CURRENT_MIN, 수집 타겟 ID: $TARGET_ID"

          # 2. API 호출 URL 생성
          URL="https://jsonplaceholder.typicode.com/todos/${TARGET_ID}"

          # 3. 데이터 수집
          NEW_DATA=$(curl -s "$URL")

          # 4. /tmp/ 디렉토리에 임시 저장
          echo "$NEW_DATA" >> "/tmp/$FILE_NAME"

          # 5. Incremental Update
          if [ ! -f "$FILE_NAME" ]; then
            echo "[" > "$FILE_NAME"
            echo "$NEW_DATA" >> "$FILE_NAME"
            echo "]" >> "$FILE_NAME"
          else
            sed -i '$d' "$FILE_NAME"
            echo "," >> "$FILE_NAME"
            echo "$NEW_DATA" >> "$FILE_NAME"
            echo "]" >> "$FILE_NAME"
          fi
          
          cat "$FILE_NAME"

      - name: Commit and Push changes
        run: |
          # [수정된 곳] 여기를 "Choi"로 맞춰야 위에서 만든 파일을 인식합니다!
          USER_NAME="Choi" 
          FILE_NAME="${USER_NAME}_test.json"
          
          git config --global user.name "github-actions-bot"
          git config --global user.email "github-actions-bot@users.noreply.github.com"
          
          git add "$FILE_NAME"
          git commit -m "Auto-update: Data collected at $(date)" || echo "No changes to commit"
          git push


